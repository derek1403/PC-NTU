<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¢±é¢¨ 3D ç‹€æ…‹åœ– (å¸¶ç¯©é¸)</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      display: flex; 
      height: 100vh; 
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
    }
    #plot { 
      flex: 3; 
      background: white;
    }
    #sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-left: 3px solid #4a90e2;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    #filter-panel {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom: 2px solid #5568d3;
    }
    #filter-panel h3 {
      margin-bottom: 15px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-group {
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 8px;
    }
    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.9em;
    }
    .filter-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .filter-row select {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: white;
      color: #333;
      font-size: 0.85em;
      cursor: pointer;
    }
    .filter-row span {
      font-size: 0.9em;
      font-weight: bold;
    }
    #apply-filter-btn {
      width: 100%;
      padding: 12px;
      background: #48bb78;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    #apply-filter-btn:hover {
      background: #38a169;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
    }
    #apply-filter-btn:active {
      transform: translateY(0);
    }
    #reset-filter-btn {
      width: 100%;
      padding: 10px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 8px;
    }
    #reset-filter-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    #node-info { 
      flex: 1;
      padding: 20px;
      overflow: auto;
    }
    #node-info h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    #node-info p {
      margin: 10px 0;
      color: #555;
      line-height: 1.6;
    }
    #node-info b {
      color: #2c3e50;
    }
    #node-info img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 1.2em;
      color: #4a90e2;
      z-index: 1000;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a90e2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hint {
      color: #888;
      font-style: italic;
      font-size: 0.9em;
    }
    #stats {
      margin-top: 20px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 5px;
      font-size: 0.85em;
    }
    .filter-status {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 0.85em;
      border-left: 4px solid #ffc107;
    }
    .image-container {
      margin-top: 15px;
    }
    .image-wrapper {
      position: relative;
      margin-bottom: 10px;
    }
    .image-wrapper img {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .image-caption {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
      text-align: center;
    }
    .image-loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }
  </style>
</head>
<body>
  <div id="plot"></div>
  <div id="sidebar">
    <div id="filter-panel">
      <h3>ğŸ¯ ç¯©é¸æ¢ä»¶</h3>
      
      <div class="filter-group">
        <label>RMW (km)</label>
        <div class="filter-row">
          <select id="rmw-min">
            <option value="">ä¸é™åˆ¶</option>
            <option value="0">0</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200">200</option>
            <option value="250">250</option>
          </select>
          <span>~</span>
          <select id="rmw-max">
            <option value="">ä¸é™åˆ¶</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200">200</option>
            <option value="250">250</option>
            <option value="300">300</option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label>Vmax (m/s)</label>
        <div class="filter-row">
          <select id="vmax-min">
            <option value="">ä¸é™åˆ¶</option>
            <option value="0">0</option>
            <option value="17">17 (Tc)</option>
            <option value="33">33 (C1)</option>
            <option value="51">51 (C3)</option>
            <option value="58">58 (C4)</option>
            <option value="70">70 (C5)</option>
          </select>
          <span>~</span>
          <select id="vmax-max">
            <option value="">ä¸é™åˆ¶</option>
            <option value="17">17 (Tc)</option>
            <option value="33">33 (C1)</option>
            <option value="51">51 (C3)</option>
            <option value="58">58 (C4)</option>
            <option value="70">70 (C5)</option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label>IKE (TJ)</label>
        <div class="filter-row">
          <select id="ike-min">
            <option value="">ä¸é™åˆ¶</option>
            <option value="0">0</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200">200</option>
            <option value="250">250</option>
          </select>
          <span>~</span>
          <select id="ike-max">
            <option value="">ä¸é™åˆ¶</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200">200</option>
            <option value="250">250</option>
            <option value="300">300</option>
          </select>
        </div>
      </div>

      <button id="apply-filter-btn">âœ“ å¥—ç”¨ç¯©é¸</button>
      <button id="reset-filter-btn">â†º é‡ç½®</button>
    </div>

    <div id="node-info">
      <div class="hint">
        <p>ğŸ’¡ æç¤ºï¼šé»æ“Šåœ–ä¸­çš„ç¯€é»æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
        <p>ğŸ–±ï¸ å¯ä»¥æ‹–å‹•æ—‹è½‰è¦–è§’ã€æ»¾è¼ªç¸®æ”¾</p>
        <p>ğŸ¯ ä½¿ç”¨ä¸Šæ–¹ç¯©é¸å™¨éæ¿¾è³‡æ–™</p>
      </div>
      <div id="stats"></div>
    </div>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    <div>è¼‰å…¥è³‡æ–™ä¸­...</div>
  </div>

  <script type="module">
  // ==============================================================================
  // å…¨åŸŸè®Šæ•¸
  // ==============================================================================
  let allNodes = [];
  let allEdges = [];
  let metadata = {};
  let currentFilter = {
    rmwMin: null,
    rmwMax: null,
    vmaxMin: null,
    vmaxMax: null,
    ikeMin: null,
    ikeMax: null
  };

  // ==============================================================================
  // è¼‰å…¥è³‡æ–™
  // ==============================================================================
  async function loadData(filename) {
    try {
      const response = await fetch(filename);
      
      if (filename.endsWith('.gz')) {
        const buffer = await response.arrayBuffer();
        const decompressed = pako.inflate(new Uint8Array(buffer), { to: 'string' });
        return JSON.parse(decompressed);
      } else {
        return await response.json();
      }
    } catch (error) {
      console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
      document.getElementById('loading').innerHTML = `
        <div style="color: red;">âŒ è¼‰å…¥å¤±æ•—</div>
        <div style="font-size: 0.9em; margin-top: 10px;">è«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨: ${filename}</div>
      `;
      throw error;
    }
  }

  // ==============================================================================
  // åœ–ç‰‡è¼‰å…¥åŠŸèƒ½
  // ==============================================================================
  function generateTcIdCandidates(tcId) {
    const tcIdNum = tcId.slice(0, -1);
    const suffix = tcId.slice(-1);
    const year = tcIdNum.slice(0, 4);
    const num = parseInt(tcIdNum.slice(4));
    const candidates = [];
    
    for (let i = 0; i < 7; i++) {
      const tryNum = num - i;
      if (tryNum < 1) break;
      const tryTcId = `${year}${String(tryNum).padStart(2, '0')}`;
      candidates.push(tryTcId);
    }
    
    return candidates;
  }

  function loadTyphoonImage(tcId, time, order) {
    return new Promise((resolve) => {
      const tcIdCandidates = generateTcIdCandidates(tcId);
      const allCandidates = [];
      
      for (const tryTcId of tcIdCandidates) {
        allCandidates.push(
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/4/512x512/MTS1${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/4/512x512/MTS2${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/3/512x512/GOE9${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/1/512x512/GMS1${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/1/512x512/GMS2${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/1/512x512/GMS3${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/1/512x512/GMS4${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/3/512x512/GMS5${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/4/512x512/HMW8${time.slice(2)}.${tryTcId}.jpg`,
          `https://agora.ex.nii.ac.jp/digital-typhoon/wnp/by-name/${tryTcId}/4/512x512/HMW9${time.slice(2)}.${tryTcId}.jpg`
        );
      }
      
      allCandidates.push(
        `https://media.istockphoto.com/id/1503385646/zh/%E7%85%A7%E7%89%87/portrait-funny-and-happy-shiba-inu-puppy-dog-peeking-out-from-behind-a-blue-banner-isolated-on.jpg?s=612x612&w=0&k=20&c=j6W1QMERTVgCfKQq7aWLv4m4vUmzHEaC8Iul9883-iE=`
      );

      const img = document.createElement('img');
      img.alt = `é¢±é¢¨ ${tcId} åœ–ç‰‡`;
      img.style.maxWidth = "100%";
      img.style.borderRadius = "8px";
      img.style.boxShadow = "0 2px 8px rgba(0,0,0,0.15)";

      let currentIndex = 0;

      function tryLoadImage() {
        if (currentIndex >= allCandidates.length) {
          resolve(null);
          return;
        }

        const currentUrl = allCandidates[currentIndex];
        img.src = currentUrl;

        img.onload = function() {
          resolve(img);
        };

        img.onerror = function() {
          currentIndex++;
          tryLoadImage();
        };
      }

      tryLoadImage();
    });
  }

  async function loadMultipleTyphoonImages(tcIds, times, orders, container) {
    container.innerHTML = '<div class="image-loading">ğŸ–¼ï¸ è¼‰å…¥åœ–ç‰‡ä¸­...</div>';

    const maxImages = 5;
    const imagePromises = [];

    for (let i = 0; i < tcIds.length; i++) {
      const tcId = String(tcIds[i]);
      
      if (["K", "W"].includes(tcId.slice(-1))) {
        imagePromises.push(
          loadTyphoonImage(tcId, String(times[i]), orders[i])
        );
      }

      if (imagePromises.length >= maxImages) {
        break;
      }
    }

    if (imagePromises.length === 0) {
      container.innerHTML = '<div class="image-loading" style="color: #999;">âš ï¸ ç„¡è¥¿åŒ—å¤ªå¹³æ´‹é¢±é¢¨åœ–ç‰‡</div>';
      return;
    }

    const images = await Promise.all(imagePromises);
    container.innerHTML = '';

    let successCount = 0;
    images.forEach((img, index) => {
      if (img) {
        const wrapper = document.createElement('div');
        wrapper.className = 'image-wrapper';
        
        wrapper.appendChild(img);
        
        const caption = document.createElement('div');
        caption.className = 'image-caption';
        
        let originalIndex = 0;
        let validCount = 0;
        for (let j = 0; j < tcIds.length; j++) {
          if (["K", "W"].includes(String(tcIds[j]).slice(-1))) {
            if (validCount === index) {
              originalIndex = j;
              break;
            }
            validCount++;
          }
        }
        
        caption.textContent = `é¢±é¢¨ ${tcIds[originalIndex]} - ${times[originalIndex]}`;
        wrapper.appendChild(caption);
        
        container.appendChild(wrapper);
        successCount++;
      }
    });

    if (successCount === 0) {
      container.innerHTML = '<div class="image-loading" style="color: #999;">âš ï¸ ç„¡å¯ç”¨åœ–ç‰‡</div>';
    }
  }

  // ==============================================================================
  // è™•ç†åœ–è³‡æ–™æ ¼å¼
  // ==============================================================================
  function processGraphData(graphData) {
    const nodes = graphData.nodes;
    let edges = [];
    let meta = {};

    if (Array.isArray(graphData.edges)) {
      edges = graphData.edges;
      meta = {
        total_nodes: nodes.length,
        total_edges: edges.length,
        sampled_edges: edges.length,
        sample_rate: 1.0
      };
    } else if (graphData.edges && graphData.edges.x) {
      // å¾åº§æ¨™é™£åˆ—é‡å»ºé‚Šåˆ—è¡¨
      const edgeX = graphData.edges.x;
      const edgeY = graphData.edges.y;
      const edgeZ = graphData.edges.z;
      
      for (let i = 0; i < edgeX.length; i += 3) {
        if (edgeX[i] === null) continue;
        
        // æ‰¾åˆ°å°æ‡‰çš„ç¯€é»ç´¢å¼•
        const x1 = edgeX[i], y1 = edgeY[i], z1 = edgeZ[i];
        const x2 = edgeX[i+1], y2 = edgeY[i+1], z2 = edgeZ[i+1];
        
        const u = nodes.findIndex(n => n.x === x1 && n.y === y1 && n.z === z1);
        const v = nodes.findIndex(n => n.x === x2 && n.y === y2 && n.z === z2);
        
        if (u !== -1 && v !== -1) {
          edges.push([u, v]);
        }
      }
      
      meta = graphData.metadata || {
        total_nodes: nodes.length,
        total_edges: edges.length,
        sampled_edges: edges.length,
        sample_rate: 1.0
      };
    }

    return { nodes, edges, metadata: meta };
  }

  // ==============================================================================
  // ç¯©é¸ç¯€é»
  // ==============================================================================
  function filterNodes(nodes, filter) {
    return nodes.filter(node => {
      // RMW ç¯©é¸
      if (filter.rmwMin !== null && (node.RMW === undefined || node.RMW < filter.rmwMin)) {
        return false;
      }
      if (filter.rmwMax !== null && (node.RMW === undefined || node.RMW > filter.rmwMax)) {
        return false;
      }
      
      // Vmax ç¯©é¸
      if (filter.vmaxMin !== null && (node.Vmax === undefined || node.Vmax < filter.vmaxMin)) {
        return false;
      }
      if (filter.vmaxMax !== null && (node.Vmax === undefined || node.Vmax > filter.vmaxMax)) {
        return false;
      }
      
      // IKE ç¯©é¸
      if (filter.ikeMin !== null && (node.IKE === undefined || node.IKE < filter.ikeMin)) {
        return false;
      }
      if (filter.ikeMax !== null && (node.IKE === undefined || node.IKE > filter.ikeMax)) {
        return false;
      }
      
      return true;
    });
  }

  // ==============================================================================
  // ç¯©é¸é‚Š
  // ==============================================================================
  function filterEdges(edges, validNodeIds) {
    const validSet = new Set(validNodeIds);
    return edges.filter(([u, v]) => validSet.has(u) && validSet.has(v));
  }

  // ==============================================================================
  // å»ºç«‹é‚Šçš„åº§æ¨™é™£åˆ—
  // ==============================================================================
  function buildEdgeCoordinates(edges, nodes) {
    const edge_x = [];
    const edge_y = [];
    const edge_z = [];
    
    for (const [u, v] of edges) {
      if (u >= nodes.length || v >= nodes.length) continue;
      
      edge_x.push(nodes[u].x, nodes[v].x, null);
      edge_y.push(nodes[u].y, nodes[v].y, null);
      edge_z.push(nodes[u].z, nodes[v].z, null);
    }
    
    return { x: edge_x, y: edge_y, z: edge_z };
  }

  // ==============================================================================
  // æ›´æ–°åœ–è¡¨
  // ==============================================================================
  function updatePlot(nodes, edgeData, filteredEdgeCount) {
    const nodeColors = Array(nodes.length).fill('#4a90e2');
    
    const edgeTrace = {
      x: edgeData.x,
      y: edgeData.y,
      z: edgeData.z,
      mode: 'lines',
      type: 'scatter3d',
      line: { 
        color: 'rgba(150, 150, 150, 0.9)',
        width: 1
      },
      hoverinfo: 'skip',
      name: `æ™‚é–“æ¼”åŒ– (${filteredEdgeCount} æ¢é‚Š)`
    };

    const nodeTrace = {
      x: nodes.map(n => n.x),
      y: nodes.map(n => n.y),
      z: nodes.map(n => n.z),
      mode: 'markers',
      type: 'scatter3d',
      marker: {
        size: 5,
        color: nodeColors,
        opacity: 0.8,
        line: { width: 0.5, color: 'white' }
      },
      hovertext: nodes.map(n => n.info_text || `Node ${n.id}`),
      hoverinfo: 'text',
      name: `é¢±é¢¨ç‹€æ…‹ (${nodes.length} å€‹)`
    };

    const layout = {
      margin: { l: 0, r: 0, t: 0, b: 0 },
      scene: { 
        xaxis: { title: 'Layout X', showgrid: true },
        yaxis: { title: 'Layout Y', showgrid: true },
        zaxis: { title: 'Layout Z', showgrid: true },
        camera: {
          eye: { x: 1.5, y: 1.5, z: 1.5 }
        },
        bgcolor: '#f8f9fa'
      },
      hovermode: 'closest',
      showlegend: true,
      legend: {
        x: 0.02,
        y: 0.98,
        bgcolor: 'rgba(255,255,255,0.9)'
      }
    };

    const config = {
      responsive: true,
      displayModeBar: true,
      displaylogo: false
    };

    Plotly.newPlot('plot', [edgeTrace, nodeTrace], layout, config);

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    updateStats(nodes.length, filteredEdgeCount);

    // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶
    setupClickHandler(nodes);
  }

  // ==============================================================================
  // æ›´æ–°çµ±è¨ˆè³‡è¨Š
  // ==============================================================================
  function updateStats(nodeCount, edgeCount) {
    const filterActive = currentFilter.rmwMin !== null || currentFilter.rmwMax !== null ||
                        currentFilter.vmaxMin !== null || currentFilter.vmaxMax !== null ||
                        currentFilter.ikeMin !== null || currentFilter.ikeMax !== null;

    let statsHTML = `<b>ğŸ“Š è³‡æ–™çµ±è¨ˆ:</b><br>`;
    
    if (filterActive) {
      statsHTML += `é¡¯ç¤ºç¯€é»: ${nodeCount} / ${metadata.total_nodes}<br>`;
      statsHTML += `é¡¯ç¤ºé‚Š: ${edgeCount} / ${metadata.total_edges}<br>`;
      statsHTML += `<span style="color: #e74c3c;">ğŸ¯ ç¯©é¸å·²å•Ÿç”¨</span>`;
    } else {
      statsHTML += `ç¯€é»æ•¸: ${nodeCount}<br>`;
      statsHTML += `é‚Šæ•¸: ${edgeCount}`;
    }

    document.getElementById('stats').innerHTML = statsHTML;
  }

  // ==============================================================================
  // è¨­å®šé»æ“Šäº‹ä»¶
  // ==============================================================================
  function setupClickHandler(nodes) {
    const plotDiv = document.getElementById('plot');
    const nodeTraceIndex = 1;

    plotDiv.on('plotly_click', function(eventData) {
      const point = eventData.points[0];

      if (!point || point.curveNumber !== nodeTraceIndex) {
        return;
      }

      const nodeIndex = point.pointNumber;
      const node = nodes[nodeIndex];

      if (!node) return;

      const newColors = Array(nodes.length).fill('#4a90e2');
      newColors[nodeIndex] = '#e74c3c';

      setTimeout(() => {
        try {
          Plotly.restyle('plot', { 'marker.color': [newColors] }, [nodeTraceIndex]);
        } catch (e) {
          console.error("Plotly restyle error:", e);
        }
      }, 0);

      const tcIds = node.TC_ID || [];
      const times = node.time || [];
      const orders = node.order || [];

      let infoHTML = `
        <h3>ğŸŒ€ é¢±é¢¨ç‹€æ…‹</h3>
        <p><b>ç¯€é» ID:</b> ${node.id}</p>
        <p><b>ç‹€æ…‹åƒæ•¸:</b> ${node.info_text || 'N/A'}</p>
        <p><b>RMW:</b> ${node.RMW ? node.RMW.toFixed(1) : 'N/A'} km</p>
        <p><b>Vmax:</b> ${node.Vmax ? node.Vmax.toFixed(2) : 'N/A'} m/s</p>
        <p><b>IKE:</b> ${node.IKE ? node.IKE.toFixed(2) : 'N/A'} TJ</p>
        <p><b>åº§æ¨™:</b> (${node.x.toFixed(3)}, ${node.y.toFixed(3)}, ${node.z.toFixed(3)})</p>
      `;

      if (tcIds.length > 0) {
        infoHTML += `<hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">`;
        infoHTML += `<p><b>é¢±é¢¨ç·¨è™Ÿ:</b> ${tcIds.join(', ')}</p>`;
        infoHTML += `<p><b>æ™‚é–“:</b> ${times[0] || 'N/A'}</p>`;
        infoHTML += `<p><b>é †åº:</b> ${orders.join(', ')}</p>`;
      }

      infoHTML += `<hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">`;
      infoHTML += `<div id="image-container" class="image-container"></div>`;
      infoHTML += document.getElementById('stats').outerHTML;

      document.getElementById('node-info').innerHTML = infoHTML;

      const imageContainer = document.getElementById('image-container');
      if (tcIds.length > 0 && times.length > 0 && orders.length > 0) {
        loadMultipleTyphoonImages(tcIds, times, orders, imageContainer);
      } else {
        imageContainer.innerHTML = '<div class="image-loading" style="color: #999;">âš ï¸ ç„¡åœ–ç‰‡è³‡è¨Š</div>';
      }
    });
  }

  // ==============================================================================
  // å¥—ç”¨ç¯©é¸
  // ==============================================================================
  function applyFilter() {
    // è®€å–ç¯©é¸æ¢ä»¶
    const rmwMin = document.getElementById('rmw-min').value;
    const rmwMax = document.getElementById('rmw-max').value;
    const vmaxMin = document.getElementById('vmax-min').value;
    const vmaxMax = document.getElementById('vmax-max').value;
    const ikeMin = document.getElementById('ike-min').value;
    const ikeMax = document.getElementById('ike-max').value;

    currentFilter = {
      rmwMin: rmwMin ? parseFloat(rmwMin) : null,
      rmwMax: rmwMax ? parseFloat(rmwMax) : null,
      vmaxMin: vmaxMin ? parseFloat(vmaxMin) : null,
      vmaxMax: vmaxMax ? parseFloat(vmaxMax) : null,
      ikeMin: ikeMin ? parseFloat(ikeMin) : null,
      ikeMax: ikeMax ? parseFloat(ikeMax) : null
    };

    console.log('å¥—ç”¨ç¯©é¸:', currentFilter);

    // ç¯©é¸ç¯€é»
    const filteredNodes = filterNodes(allNodes, currentFilter);
    const filteredNodeIds = filteredNodes.map(n => n.id);

    // ç¯©é¸é‚Š
    const filteredEdges = filterEdges(allEdges, filteredNodeIds);

    // å»ºç«‹é‚Šçš„åº§æ¨™
    const edgeData = buildEdgeCoordinates(filteredEdges, allNodes);

    // æ›´æ–°åœ–è¡¨
    updatePlot(filteredNodes, edgeData, filteredEdges.length);

    console.log(`âœ… ç¯©é¸å®Œæˆ: ${filteredNodes.length} ç¯€é», ${filteredEdges.length} é‚Š`);
  }

  // ==============================================================================
  // é‡ç½®ç¯©é¸
  // ==============================================================================
  function resetFilter() {
    document.getElementById('rmw-min').value = '';
    document.getElementById('rmw-max').value = '';
    document.getElementById('vmax-min').value = '';
    document.getElementById('vmax-max').value = '';
    document.getElementById('ike-min').value = '';
    document.getElementById('ike-max').value = '';

    currentFilter = {
      rmwMin: null,
      rmwMax: null,
      vmaxMin: null,
      vmaxMax: null,
      ikeMin: null,
      ikeMax: null
    };

    // é¡¯ç¤ºæ‰€æœ‰è³‡æ–™
    const edgeData = buildEdgeCoordinates(allEdges, allNodes);
    updatePlot(allNodes, edgeData, allEdges.length);

    console.log('âœ… å·²é‡ç½®ç¯©é¸');
  }

  // ==============================================================================
  // ä¸»ç¨‹å¼
  // ==============================================================================
  (async () => {
    try {
      const graphData = await loadData('graph_data_full.json.gz');
      
      console.log('ğŸ“Š åŸå§‹è³‡æ–™:', graphData);
      
      const { nodes, edges, metadata: meta } = processGraphData(graphData);
      
      allNodes = nodes;
      allEdges = edges;
      metadata = meta;
      
      console.log('ğŸ“Š è™•ç†å¾Œ:', { nodes: nodes.length, edges: edges.length });
      
      document.getElementById('loading').style.display = 'none';

      // åˆå§‹æ¸²æŸ“
      const edgeData = buildEdgeCoordinates(edges, nodes);
      updatePlot(nodes, edgeData, edges.length);

      // ç¶å®šç¯©é¸æŒ‰éˆ•
      document.getElementById('apply-filter-btn').addEventListener('click', applyFilter);
      document.getElementById('reset-filter-btn').addEventListener('click', resetFilter);

      console.log(`âœ… åœ–è¡¨æ¸²æŸ“å®Œæˆ!`);

    } catch (error) {
      console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
      document.getElementById('loading').innerHTML = `
        <div style="color: red;">âŒ ç™¼ç”ŸéŒ¯èª¤</div>
        <div style="font-size: 0.9em; margin-top: 10px;">${error.message}</div>
      `;
    }
  })();
  </script>
</body>
</html>