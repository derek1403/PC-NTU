<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¢±é¢¨ 3D ç‹€æ…‹åœ– (å„ªåŒ–ç‰ˆ)</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      display: flex; 
      height: 100vh; 
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
    }
    #plot { 
      flex: 3; 
      background: white;
    }
    #node-info { 
      flex: 1; 
      padding: 20px; 
      background: white;
      border-left: 3px solid #4a90e2;
      overflow: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    #node-info h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    #node-info p {
      margin: 10px 0;
      color: #555;
      line-height: 1.6;
    }
    #node-info b {
      color: #2c3e50;
    }
    #node-info img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 1.2em;
      color: #4a90e2;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a90e2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hint {
      color: #888;
      font-style: italic;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="plot"></div>
  <div id="node-info">
    <div class="hint">
      <p>ğŸ’¡ æç¤ºï¼šé»æ“Šåœ–ä¸­çš„ç¯€é»æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
      <p>ğŸ–±ï¸ å¯ä»¥æ‹–å‹•æ—‹è½‰è¦–è§’ã€æ»¾è¼ªç¸®æ”¾</p>
    </div>
  </div>
  <div id="loading">
    <div class="spinner"></div>
    <div>è¼‰å…¥è³‡æ–™ä¸­...</div>
  </div>

  <script type="module">
  // ==============================================================================
  // è¼‰å…¥è³‡æ–™ (æ”¯æ´ .json å’Œ .json.gz)
  // ==============================================================================
  async function loadData(filename) {
    try {
      const response = await fetch(filename);
      
      // æª¢æŸ¥æ˜¯å¦æ˜¯ gzip å£“ç¸®æª”æ¡ˆ
      if (filename.endsWith('.gz')) {
        const buffer = await response.arrayBuffer();
        const decompressed = pako.inflate(new Uint8Array(buffer), { to: 'string' });
        return JSON.parse(decompressed);
      } else {
        return await response.json();
      }
    } catch (error) {
      console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
      document.getElementById('loading').innerHTML = `
        <div style="color: red;">âŒ è¼‰å…¥å¤±æ•—</div>
        <div style="font-size: 0.9em; margin-top: 10px;">è«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨: ${filename}</div>
      `;
      throw error;
    }
  }

  // ==============================================================================
  // ä¸»ç¨‹å¼
  // ==============================================================================
  (async () => {
    // ğŸ”§ ä¿®æ”¹é€™è£¡ä¾†è¼‰å…¥ä¸åŒçš„æª”æ¡ˆ
    // é¸é … 1: å®Œæ•´ç‰ˆ (æ‰€æœ‰é‚Š)
    const graphData = await loadData('graph_data_full.json.gz');
    
    // é¸é … 2: è¼•é‡ç‰ˆ (20% é‚Šï¼Œè¼‰å…¥æ›´å¿«)
    // const graphData = await loadData('graph_data_light.json.gz');
    
    // é¸é … 3: æœªå£“ç¸®ç‰ˆæœ¬
    //const graphData = await loadData('graph_data_Dsat_round5.json');

    console.log('ğŸ“Š è³‡æ–™è¼‰å…¥æˆåŠŸ:', graphData.metadata);
    document.getElementById('loading').style.display = 'none';

    const nodes = graphData.nodes;
    const edges = graphData.edges;

    // ==============================================================================
    // ğŸš€ é—œéµå„ªåŒ–: æ‰€æœ‰é‚Šç”¨ä¸€å€‹ trace (ä¸æ˜¯ 85805 å€‹!)
    // ==============================================================================
    const edgeTrace = {
      x: edges.x,
      y: edges.y,
      z: edges.z,
      mode: 'lines',
      type: 'scatter3d',
      line: { 
        color: 'rgba(150, 150, 150, 0.7)',  // åŠé€æ˜ç°è‰²
        width: 1
      },
      hoverinfo: 'skip',
      name: 'æ™‚é–“æ¼”åŒ–'
    };

    // ==============================================================================
    // ç¹ªè£½ç¯€é»
    // ==============================================================================
    const nodeColors = Array(nodes.length).fill('#4a90e2');
    const nodeTrace = {
      x: nodes.map(n => n.x),
      y: nodes.map(n => n.y),
      z: nodes.map(n => n.z),
      mode: 'markers',
      type: 'scatter3d',
      marker: {
        size: 5,
        color: nodeColors,
        opacity: 0.8,
        line: { width: 0.5, color: 'white' }
      },
      hovertext: nodes.map(n => n.info_text),
      hoverinfo: 'text',
      name: 'é¢±é¢¨ç‹€æ…‹'
    };

    // ==============================================================================
    // é…ç½®åœ–è¡¨
    // ==============================================================================
    const layout = {
      margin: { l: 0, r: 0, t: 0, b: 0 },
      scene: { 
        xaxis: { title: 'Layout X', showgrid: true },
        yaxis: { title: 'Layout Y', showgrid: true },
        zaxis: { title: 'Layout Z', showgrid: true },
        camera: {
          eye: { x: 1.5, y: 1.5, z: 1.5 }
        },
        bgcolor: '#f8f9fa'
      },
      hovermode: 'closest',
      showlegend: true,
      legend: {
        x: 0.02,
        y: 0.98,
        bgcolor: 'rgba(255,255,255,0.8)'
      }
    };

    const config = {
      responsive: true,
      displayModeBar: true,
      displaylogo: false
    };

    // ç¹ªè£½åœ–è¡¨: [é‚Šçš„ trace, ç¯€é»çš„ trace]
    Plotly.newPlot('plot', [edgeTrace, nodeTrace], layout, config);

    // ==============================================================================
    // é»æ“Šäº‹ä»¶
    // ==============================================================================
    const plotDiv = document.getElementById('plot');
    const nodeTraceIndex = 1; // ç¯€é»æ˜¯ç¬¬äºŒå€‹ trace (ç´¢å¼• 1)

    plotDiv.on('plotly_click', function(eventData) {
      const point = eventData.points[0];

      // ç¢ºä¿é»æ“Šçš„æ˜¯ç¯€é» trace
      if (!point || point.curveNumber !== nodeTraceIndex) {
        return;
      }

      const nodeIndex = point.pointNumber;
      const node = nodes[nodeIndex];

      if (!node) return;

      // æ›´æ–°ç¯€é»é¡è‰²
      const newColors = Array(nodes.length).fill('#4a90e2');
      newColors[nodeIndex] = '#e74c3c'; // é¸ä¸­çš„ç¯€é»è®Šç´…è‰²

      setTimeout(() => {
        try {
          Plotly.restyle('plot', { 'marker.color': [newColors] }, [nodeTraceIndex]);
        } catch (e) {
          console.error("Plotly restyle error:", e);
        }
      }, 0);

      // æ›´æ–°å³å´è³‡è¨Š
      document.getElementById('node-info').innerHTML = `
        <h3>ğŸŒ€ é¢±é¢¨ç‹€æ…‹</h3>
        <p><b>ç¯€é» ID:</b> ${node.id}</p>
        <p><b>ç‹€æ…‹åƒæ•¸:</b> ${node.info_text}</p>
        <p><b>åº§æ¨™:</b> (${node.x.toFixed(3)}, ${node.y.toFixed(3)}, ${node.z.toFixed(3)})</p>
        <p><b>åŸå§‹ç‹€æ…‹:</b> ${node.board_state}</p>
        <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
        <img src="${node.image_url}" alt="é¢±é¢¨åœ–ç‰‡" onerror="this.style.display='none'">
      `;
    });

    // é¡¯ç¤ºè³‡æ–™çµ±è¨ˆ
    console.log(`
    ğŸ“Š åœ–è¡¨çµ±è¨ˆ:
    - ç¸½ç¯€é»æ•¸: ${graphData.metadata.total_nodes}
    - åŸå§‹é‚Šæ•¸: ${graphData.metadata.total_edges}
    - é¡¯ç¤ºé‚Šæ•¸: ${graphData.metadata.sampled_edges}
    - å–æ¨£ç‡: ${(graphData.metadata.sample_rate * 100).toFixed(1)}%
    `);
  })();
  </script>
</body>
</html>